---
description: 現在の機能仕様における不十分な領域を特定し、最大5つの高度にターゲットを絞った明確化質問を行い、その回答を仕様にエンコードします。
---

ユーザー入力は、エージェントによって直接提供されるか、コマンド引数として提供される可能性があります。**必ず**それを考慮してプロンプトを進めてください（空でない場合）。

ユーザー入力:

$ARGUMENTS

目標: アクティブな機能仕様における曖昧さや欠落している意思決定ポイントを検出し、明確化を仕様ファイルに直接記録します。

注意: この明確化ワークフローは、`/plan`を呼び出す前に実行（および完了）する必要があります。ユーザーが明確化をスキップすることを明示的に述べた場合（例: 探索的スパイク）、進行することは可能ですが、下流での再作業リスクが増加することを警告する必要があります。

実行手順:

1. リポジトリのルートから`.specify/scripts/bash/check-prerequisites.sh --json --paths-only`を1回実行します（`--json --paths-only`モードを組み合わせたもの）。最小限のJSONペイロードフィールドを解析:
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - （オプションで`IMPL_PLAN`、`TASKS`を将来の連鎖フロー用にキャプチャ）
   - JSON解析に失敗した場合、中止してユーザーに`/specify`を再実行するか、機能ブランチ環境を確認するよう指示します。

2. 現在の仕様ファイルを読み込みます。この分類法を使用して構造化された曖昧さとカバレッジスキャンを実行します。各カテゴリについて、ステータスをマーク: 明確 / 部分的 / 欠落。優先順位付けに使用される内部カバレッジマップを生成します（質問がまったく行われない場合を除き、生のマップを出力しないでください）。

   機能範囲と動作:
   - コアユーザー目標と成功基準
   - 明示的な範囲外宣言
   - ユーザーロール/ペルソナの区別

   ドメインとデータモデル:
   - エンティティ、属性、関係
   - アイデンティティと一意性ルール
   - ライフサイクル/状態遷移
   - データ量/スケールの仮定

   インタラクションとUXフロー:
   - 重要なユーザージャーニー/シーケンス
   - エラー/空/読み込み状態
   - アクセシビリティまたはローカリゼーションの注意点

   非機能的品質属性:
   - パフォーマンス（レイテンシ、スループット目標）
   - スケーラビリティ（水平/垂直、制限）
   - 信頼性と可用性（稼働時間、復旧期待値）
   - 可観測性（ログ、メトリクス、トレース信号）
   - セキュリティとプライバシー（認証/認可、データ保護、脅威の仮定）
   - コンプライアンス/規制制約（該当する場合）

   統合と外部依存関係:
   - 外部サービス/APIと障害モード
   - データインポート/エクスポート形式
   - プロトコル/バージョン管理の仮定

   エッジケースと障害処理:
   - ネガティブシナリオ
   - レート制限/スロットリング
   - 競合解決（例: 同時編集）

   制約とトレードオフ:
   - 技術的制約（言語、ストレージ、ホスティング）
   - 明示的なトレードオフまたは却下された代替案

   用語と一貫性:
   - 標準的な用語集の用語
   - 回避された同義語/非推奨用語

   完了シグナル:
   - 受け入れ基準のテスト可能性
   - 測定可能な完了の定義スタイルの指標

   その他/プレースホルダー:
   - TODOマーカー/未解決の意思決定
   - 定量化を欠く曖昧な形容詞（"堅牢"、"直感的"）

   部分的または欠落しているステータスのある各カテゴリについて、次の条件を除き、候補質問の機会を追加:
   - 明確化が実装または検証戦略を実質的に変更しない場合
   - 情報が計画フェーズに延期される方が適切な場合（内部的に記録）

3. 候補明確化質問の優先キューを（内部的に）生成（最大5つ）。すべてを一度に出力しないでください。これらの制約を適用:
    - セッション全体で合計5つの質問まで。
    - 各質問は次のいずれかで回答可能でなければなりません:
       * 短い複数選択（2〜5つの明確に排他的なオプション）、または
       * 一言/短いフレーズの回答（明示的に制約: "回答は5単語以内"）。
   - 回答がアーキテクチャ、データモデリング、タスク分解、テスト設計、UX動作、運用準備、またはコンプライアンス検証に実質的に影響を与える質問のみを含める。
   - カテゴリカバレッジのバランスを確保: 最も影響の大きい未解決カテゴリを最初にカバーするよう努める; 低影響の質問を2つ尋ねる代わりに、1つの高影響領域（例: セキュリティ姿勢）が未解決の場合を避ける。
   - すでに回答済みの質問、些細なスタイルの好み、または計画レベルの実行詳細（正確性を妨げない限り）を除外。
   - 下流の再作業リスクを軽減するか、受け入れテストの不整合を防ぐ明確化を優先。
   - 未解決カテゴリが5つ以上残っている場合、（影響*不確実性）ヒューリスティックで上位5つを選択。

4. 順次質問ループ（対話型）:
    - 一度に正確に1つの質問を提示。
    - 複数選択質問の場合、オプションをMarkdownテーブルとしてレンダリング:

       | オプション | 説明 |
       |--------|-------------|
       | A | <オプションAの説明> |
       | B | <オプションBの説明> |
       | C | <オプションCの説明> |（必要に応じてD/Eを追加、最大5つまで）
       | 短い回答 | 別の短い回答を提供（<=5単語） |（自由形式の代替が適切な場合のみ含む）

    - 短い回答スタイル（意味のある離散オプションがない場合）の場合、質問の後に1行を出力: `形式: 短い回答（<=5単語）`。
    - ユーザーが回答した後:
       * 回答が1つのオプションにマッピングされるか、<=5単語の制約に適合することを検証。
       * 曖昧な場合、迅速な明確化を求める（同じ質問に属するカウント; 進行しない）。
       * 満足のいく回答が得られたら、作業メモリに記録（まだディスクに書き込まない）し、次のキューに移動。
    - 次の条件でさらに質問を停止:
       * すべての重要な曖昧さが早期に解決（残りのキュー項目が不要になる）、または
       * ユーザーが完了を示す（"完了"、"良い"、"これ以上ない"）、または
       * 5つの質問が終了。
    - 将来のキュー質問を事前に明らかにしないでください。
    - 開始時に有効な質問がない場合、重要な曖昧さがないことを即座に報告。

5. 各受け入れられた回答後の統合（インクリメンタル更新アプローチ）:
    - セッション開始時にロードされた仕様のメモリ内表現と生のファイル内容を維持。
    - このセッションでの最初の統合回答について:
       * `## Clarifications`セクションが存在することを確認（欠けている場合、仕様テンプレートに従って最上位のコンテキスト/概要セクションの直後に作成）。
       * その下に、今日の日付の`### Session YYYY-MM-DD`サブヘッディングを作成（存在しない場合）。
    - 承認直後に箇条書きを追加: `- Q: <質問> → A: <最終回答>`。
    - 次に、最も適切なセクションに明確化を即座に適用:
       * 機能の曖昧さ → 機能要件に箇条書きを追加または更新。
       * ユーザーインタラクション/アクターの区別 → ユーザーストーリーまたはアクターサブセクション（存在する場合）を更新し、明確化された役割、制約、またはシナリオを追加。
       * データ形状/エンティティ → データモデルを更新（フィールド、タイプ、関係を追加）し、順序を保持; 追加された制約を簡潔に記載。
       * 非機能制約 → 非機能/品質属性セクションで測定可能な基準を追加/変更（曖昧な形容詞をメトリックまたは明確な目標に変換）。
       * エッジケース/ネガティブフロー → エッジケース/エラーハンドリングの下に新しい箇条書きを追加（またはテンプレートがプレースホルダーを提供している場合はそのセクションを作成）。
       * 用語の矛盾 → 仕様全体で用語を正規化; 必要に応じて元の用語を保持し、`（以前は"X"と呼ばれていた）`を1回追加。
    - 明確化が以前の曖昧な記述を無効にする場合、その記述を置き換える（重複を避ける）。矛盾する古いテキストを残さない。
    - 各統合後に仕様ファイルを保存して、コンテキストの損失リスクを最小化（アトミック上書き）。
    - フォーマットを保持: 無関係なセクションを並べ替えない; 見出し階層を維持。
    - 挿入された各明確化を最小限かつテスト可能に保つ（物語的な逸脱を避ける）。

6. 検証（各書き込み後および最終パスで実行）:
   - 明確化セッションには、受け入れられた回答ごとに正確に1つの箇条書きが含まれる（重複なし）。
   - 質問数（受け入れ済み）≤ 5。
   - 更新されたセクションには、新しい回答が解決するはずの曖昧なプレースホルダーが残っていない。
   - 矛盾する以前の記述が残っていない（削除された無効な代替選択をスキャン）。
   - Markdown構造が有効; 許可される新しい見出しのみ: `## Clarifications`、`### Session YYYY-MM-DD`。
   - 用語の一貫性: 更新されたすべてのセクションで同じ標準用語を使用。

7. 更新された仕様を`FEATURE_SPEC`に書き戻します。

8. 完了を報告（質問ループ終了後または早期終了時）:
   - 質問数と回答数。
   - 更新された仕様へのパス。
   - 触れたセクション（名前をリスト）。
   - 各分類法カテゴリをリストしたカバレッジサマリーテーブル（ステータス: 解決済み（部分的/欠落で対応済み）、延期（質問数制限を超えるか計画に適している）、明確（すでに十分）、未解決（まだ部分的/欠落だが低影響））。
   - 未解決または延期が残っている場合、`/plan`に進むか、計画後に再度`/clarify`を実行するかを推奨。
   - 次のコマンドを提案。

動作ルール:
- 意味のある曖昧さが見つからない場合（またはすべての潜在的な質問が低影響である場合）、"正式な明確化に値する重要な曖昧さは検出されませんでした。"と応答し、進行を提案。
- 仕様ファイルが欠落している場合、ユーザーに`/specify`を最初に実行するよう指示（ここで新しい仕様を作成しない）。
- 合計5つの質問を超えない（単一の質問に対する明確化の再試行は新しい質問としてカウントされない）。
- 推測的な技術スタックの質問を避ける（欠如が機能の明確さを妨げない限り）。
- ユーザーの早期終了シグナル（"停止"、"完了"、"進行"）を尊重。
 - 質問が完全カバレッジのために行われない場合、コンパクトなカバレッジサマリ（すべてのカテゴリが明確）を出力し、進行を提案。
 - 質問数制限に達し、未解決の高影響カテゴリが残っている場合、それらを延期として明示的にフラグし、理由を記載。

優先順位付けのコンテキスト: $ARGUMENTS
